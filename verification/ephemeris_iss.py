import numpy as np
import scipy.linalg as la
from astropy.time import Time
from astropy.coordinates import solar_system_ephemeris, get_body_barycentric
import astropy.units as u
from verification.util import build_observations, build_epochs, get_satellite_position_over_time
from src.interface.tle_dto import TLE
from src.enums import Frames
from src.dto import PropParams
from src.interface.local_angles import get_local_angles_via_state_propagation
from src.frames import eci_to_icrs, lla_to_ecef, ecef_to_eci
from src.observation_function import get_ra_and_dec


tle_string = """
ISS (ZARYA)             
1 25544U 98067A   20202.44882139 -.00000250  00000-0  35814-5 0  9999
2 25544  51.6421 183.8397 0001306 134.1760 329.9627 15.49516142237178
"""
obs_pos = [29.218103 * u.deg, -81.031723 * u.deg, 0 * u.km]
tle = TLE.from_lines(tle_string)

x, epoch = tle.to_state()
params = PropParams(epoch)
desired_epoch = Time("2020-07-20T00:00:00.000", format="isot", scale="utc")
dt = 1
epochs = build_epochs(desired_epoch, dt * u.h, 48)

obj_eci, epochs = get_satellite_position_over_time(x, epochs)
# for i in range(len(epochs)):
    # obj = eci_to_icrs(obj_eci[i], epochs[i])
    # obs = eci_to_icrs(ecef_to_eci(lla_to_ecef(obs_pos), epochs[1]), epochs[i])
    # rr = obj - obs
    # print(get_ra_and_dec(rr))
    # print(rr)
    # print(positions[i])
    # print("norms")
    # print(la.norm(positions[i]))

# observations = build_observations(x, params, obs_pos, Frames.LLA, epochs)

# for obs in observations:
#     print(obs.obs_values)
#
n = len(epochs)
locals = get_local_angles_via_state_propagation(x, params, epochs[0], epochs[n-1], n-2, obs_pos, Frames.LLA)
for local in locals:
    local[2].format = 'isot'
    print(local)

 # Date__(UT)__HR:MN     R.A.___(ICRF)___DEC R.A._(a-appar)_DEC. Azi_(a-appr)_Elev
 # 2020-Jul-20 00:00 *     0.05070  10.84112   0.31231  10.95381  47.0208 -36.3402
 # 2020-Jul-20 01:00 N   127.30069 -35.33755 127.48970 -35.40576 242.8426 -27.6417
 # 2020-Jul-20 02:00      51.59770 -32.11709  51.79858 -32.04375 105.8656 -76.3935
 # 2020-Jul-20 03:00      36.35511  42.44152  36.67421  42.52912  32.0578  -6.8717
 # 2020-Jul-20 04:00     133.00907 -30.65197 133.21326 -30.72887 258.1257 -59.0407
 # 2020-Jul-20 05:00      60.83152 -31.49589  61.02673 -31.43788 106.3262 -46.0039
 # 2020-Jul-20 06:00     177.09639  22.66602 177.35492  22.55637 311.5023 -19.3800
 # 2020-Jul-20 07:00     143.49001 -34.02932 143.69799 -34.12051 191.5524 -84.9907
 # 2020-Jul-20 08:00      57.96989 -44.78454  58.13028 -44.72084 133.7371 -14.0170
 # 2020-Jul-20 09:00     196.79994   6.45559 197.05449   6.34949 322.5631 -47.3431
 # 2020-Jul-20 10:00 N   156.62333 -45.15268 156.83166 -45.25790 132.0319 -60.9900
 # 2020-Jul-20 11:00 *m  289.71007 -16.31613 290.00593 -16.27707 256.9086 -10.1073
 # 2020-Jul-20 12:00 *m  209.70439  -2.12347 209.96598  -2.22034  16.6401 -62.0193
 # 2020-Jul-20 13:00 *m  183.97100 -71.82888 184.24794 -71.94567 162.3539 -40.0443
 # 2020-Jul-20 14:00 *m  289.69545   4.51585 289.95167   4.55514 302.7144 -37.2994
 # 2020-Jul-20 15:00 *m  220.67798 -13.70392 220.95654 -13.78940  77.3843 -48.3860
 # 2020-Jul-20 16:00 *m  336.46718 -60.94432 336.81519 -60.83737 213.1399 -40.2083
 # 2020-Jul-20 17:00 *m  298.90320  10.03496 299.15043  10.09059 350.3511 -50.2313
 # 2020-Jul-20 18:00 *m  228.02345 -42.82220 228.36331 -42.89995 126.3097 -26.6128
 # 2020-Jul-20 19:00 *m  356.44049 -33.36608 356.70736 -33.25017 253.3324 -61.0073
 # 2020-Jul-20 20:00 *m  310.17876  14.99673 310.42037  15.07025  34.7612 -38.3106
 # 2020-Jul-20 21:00 *m   89.23729 -74.86550  89.06153 -74.86114 196.8826 -26.5753
 # 2020-Jul-20 22:00 *m    9.66365 -20.51236   9.91737 -20.39852 349.0339 -81.0286
 # 2020-Jul-20 23:00 *m  326.25103  29.70246 326.48005  29.79578  47.4093 -10.0004
 # 2020-Jul-21 00:00 *m   83.08374 -47.43661  83.21439 -47.42021 229.4728 -50.9677
 # 2020-Jul-21 01:00 N    21.80298 -12.98255  22.05298 -12.87576  67.1481 -56.7973
 # 2020-Jul-21 02:00     141.22941  12.28640 141.49877  12.19998 288.9919  -8.2196
 # 2020-Jul-21 03:00      92.17045 -40.75729  92.32598 -40.75937 210.1181 -76.3150
 # 2020-Jul-21 04:00      34.00058  -4.94728  34.25369  -4.85247  81.2064 -24.9104
 # 2020-Jul-21 05:00     157.69971  -5.93901 157.95025  -6.04261 290.0032 -42.0517
 # 2020-Jul-21 06:00     102.14299 -43.67203 102.28964 -43.69406 131.9237 -64.6483
 # 2020-Jul-21 07:00     177.18778  77.63935 177.45811  77.53176 352.6808  18.6859
 # 2020-Jul-21 08:00     170.23523 -13.63711 170.48642 -13.74815 321.8402 -70.9670
 # 2020-Jul-21 09:00     110.56211 -60.04299 110.62723 -60.08144 145.4774 -38.4035
 # 2020-Jul-21 10:00 N   233.21607  18.24682 233.44809  18.18211 311.8956 -25.8188
 # 2020-Jul-21 11:00 *   182.73384 -23.49275 182.99298 -23.60625  77.9328 -70.7089
 # 2020-Jul-21 12:00 *m  316.19959 -71.12170 316.70141 -71.03809 200.7886 -24.9651
 # 2020-Jul-21 13:00 *m  244.52480  12.98467 244.76398  12.93844 344.2579 -46.5155
 # 2020-Jul-21 14:00 *m  197.06027 -42.94636 197.34918 -43.05683 123.1760 -46.9716
 # 2020-Jul-21 15:00 *m  320.08000 -26.72032 320.38111 -26.63184 258.5667 -40.4298
 # 2020-Jul-21 16:00 *m  254.57883   9.69059 254.82360   9.66252  34.4005 -44.7450
 # 2020-Jul-21 17:00 *m  249.02834 -81.27252 250.00066 -81.31580 172.6341 -35.2762
 # 2020-Jul-21 18:00 *m  330.85280  -9.60718 331.12585  -9.50709 308.9823 -61.3533
 # 2020-Jul-21 19:00 *m  261.33641   3.07885 261.59412   3.06336  72.8700 -22.2137
 # 2020-Jul-21 20:00 *m   23.29123 -56.47938  23.48382 -56.37083 216.0127 -48.7058
 # 2020-Jul-21 21:00 *m  342.97595  -0.33835 343.23916  -0.22944  21.5047 -59.2303
 # 2020-Jul-21 22:00 *m  179.50051 -54.94334 179.75431 -55.05935 185.3538   5.3415
 # 2020-Jul-21 23:00 *m   38.40174 -39.79080  38.60130 -39.69831 224.7710 -74.1571
 # 2020-Jul-22 00:00 *m  357.78718   9.98262 358.04844  10.09546  51.5020 -34.1742